{% extends "base.html" %} {% block title %}Edit Template - Templr{% endblock %}
{% block content %}
<div
  class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom"
>
  <h1 class="h2">Edit Template: {{ template.name }}</h1>
  <a href="/templates" class="btn btn-outline-secondary">
    <i class="bi bi-arrow-left"></i> Back to Templates
  </a>
</div>

<form id="templateForm">
  <div class="row">
    <div class="col-md-8">
      <div class="card">
        <div class="card-header">
          <h5>Template Details</h5>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <label for="name" class="form-label">Template Name</label>
            <input
              type="text"
              class="form-control"
              id="name"
              name="name"
              value="{{ template.name }}"
              required
            />
          </div>

          <div class="mb-3">
            <label for="slug" class="form-label">URL Slug</label>
            <div class="input-group">
              <span class="input-group-text">/</span>
              <input
                type="text"
                class="form-control"
                id="slug"
                name="slug"
                value="{{ template.slug }}"
                required
              />
              <span class="input-group-text">/[identifier]</span>
            </div>
            <div class="form-text">
              Only letters, numbers, hyphens, and underscores allowed
            </div>
          </div>

          <div class="mb-3">
            <label for="description" class="form-label">Description</label>
            <textarea
              class="form-control"
              id="description"
              name="description"
              rows="3"
            >
{{ template.description or '' }}</textarea
            >
          </div>

          <div class="mb-3">
            <label for="content" class="form-label">Template Content</label>
            <textarea
              class="form-control"
              id="content"
              name="content"
              rows="15"
              required
            >
{{ template.content }}</textarea
            >
            <div class="form-text">
              Use Jinja2 syntax. Variables: {{ variable_name }}
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card">
        <div
          class="card-header d-flex justify-content-between align-items-center"
        >
          <h6>Variables</h6>
          <button
            type="button"
            class="btn btn-sm btn-outline-primary"
            onclick="addVariable()"
          >
            <i class="bi bi-plus"></i> Add
          </button>
        </div>
        <div class="card-body">
          <div id="variables-container">
            <!-- Variables will be populated here -->
          </div>
        </div>
      </div>

      <div class="card mt-3">
        <div class="card-header">
          <h6>Preview</h6>
        </div>
        <div class="card-body">
          <button
            type="button"
            class="btn btn-outline-info btn-sm w-100"
            onclick="previewTemplate()"
          >
            <i class="bi bi-eye"></i> Preview Template
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="row mt-3">
    <div class="col-12">
      <button type="submit" class="btn btn-primary">
        <i class="bi bi-check"></i> Update Template
      </button>
      <a href="/templates" class="btn btn-secondary ms-2">Cancel</a>
      <button
        type="button"
        class="btn btn-danger ms-2"
        onclick="deleteTemplate()"
      >
        <i class="bi bi-trash"></i> Delete Template
      </button>
    </div>
  </div>
</form>
{% endblock %} {% block scripts %}
<script>
  let variableCount = 0;
  const templateVariables = {{ template.variables | tojson }};

  function addVariable(varData = null) {
      const container = document.getElementById('variables-container');
      const variableDiv = document.createElement('div');
      variableDiv.className = 'mb-3 variable-item';
      variableDiv.innerHTML = `
          <div class="row">
              <div class="col-6">
                  <input type="text" class="form-control form-control-sm" placeholder="Variable name"
                         name="var_name_${variableCount}" value="${varData ? varData.name : ''}">
              </div>
              <div class="col-4">
                  <select class="form-select form-select-sm" name="var_type_${variableCount}">
                      <option value="string" ${varData && varData.type === 'string' ? 'selected' : ''}>String</option>
                      <option value="number" ${varData && varData.type === 'number' ? 'selected' : ''}>Number</option>
                      <option value="date" ${varData && varData.type === 'date' ? 'selected' : ''}>Date</option>
                  </select>
              </div>
              <div class="col-2">
                  <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeVariable(this)">
                      <i class="bi bi-trash"></i>
                  </button>
              </div>
          </div>
      `;
      container.appendChild(variableDiv);
      variableCount++;
  }

  function removeVariable(button) {
      button.closest('.variable-item').remove();
  }

  // Load existing variables
  templateVariables.forEach(variable => {
      addVariable(variable);
  });

  // Add empty variable if none exist
  if (templateVariables.length === 0) {
      addVariable();
  }

  document.getElementById('templateForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const formData = new FormData(e.target);
      const variables = [];

      // Collect variables
      const variableItems = document.querySelectorAll('.variable-item');
      variableItems.forEach((item, index) => {
          const nameInput = item.querySelector(`input[name^="var_name_"]`);
          const typeSelect = item.querySelector(`select[name^="var_type_"]`);

          if (nameInput && nameInput.value.trim()) {
              variables.push({
                  name: nameInput.value.trim(),
                  type: typeSelect.value,
                  required: true
              });
          }
      });

      const templateData = {
          name: formData.get('name'),
          slug: formData.get('slug'),
          description: formData.get('description'),
          content: formData.get('content'),
          variables: variables
      };

      try {
          const response = await fetch(`/api/templates/{{ template.id }}`, {
              method: 'PUT',
              headers: {
                  'Content-Type': 'application/json',
              },
              body: JSON.stringify(templateData),
              credentials: 'include'
          });

          if (response.ok) {
              showAlert('Template updated successfully', 'success');
              setTimeout(() => window.location.href = '/templates', 1000);
          } else {
              const error = await response.json();
              showAlert(error.detail || 'Failed to update template', 'danger');
          }
      } catch (error) {
          showAlert('Failed to update template', 'danger');
      }
  });

  async function deleteTemplate() {
      if (confirm('Are you sure you want to delete this template? This action cannot be undone.')) {
          try {
              const response = await fetch(`/api/templates/{{ template.id }}`, {
                  method: 'DELETE',
                  credentials: 'include'
              });

              if (response.ok) {
                  showAlert('Template deleted successfully', 'success');
                  setTimeout(() => window.location.href = '/templates', 1000);
              } else {
                  const error = await response.json();
                  showAlert(error.detail || 'Failed to delete template', 'danger');
              }
          } catch (error) {
              showAlert('Failed to delete template', 'danger');
          }
      }
  }

  function previewTemplate() {
      const content = document.getElementById('content').value;
      if (!content.trim()) {
          showAlert('Please enter template content first', 'warning');
          return;
      }

      // Open preview in new window
      const previewWindow = window.open('', '_blank');
      previewWindow.document.write(`
          <html>
              <head><title>Template Preview</title></head>
              <body style="font-family: Arial, sans-serif; padding: 20px;">
                  <h3>Template Preview</h3>
                  <pre style="background: #f8f9fa; padding: 15px; border-radius: 5px;">${content}</pre>
              </body>
          </html>
      `);
  }
</script>
{% endblock %}
